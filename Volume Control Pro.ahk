; Standard Icons (ID 200 to 300)
;@Ahk2Exe-AddResource .\icons\vol_0.ico, 200
;@Ahk2Exe-AddResource .\icons\vol_1.ico, 201
;@Ahk2Exe-AddResource .\icons\vol_2.ico, 202
;@Ahk2Exe-AddResource .\icons\vol_3.ico, 203
;@Ahk2Exe-AddResource .\icons\vol_4.ico, 204
;@Ahk2Exe-AddResource .\icons\vol_5.ico, 205
;@Ahk2Exe-AddResource .\icons\vol_6.ico, 206
;@Ahk2Exe-AddResource .\icons\vol_7.ico, 207
;@Ahk2Exe-AddResource .\icons\vol_8.ico, 208
;@Ahk2Exe-AddResource .\icons\vol_9.ico, 209
;@Ahk2Exe-AddResource .\icons\vol_10.ico, 210
;@Ahk2Exe-AddResource .\icons\vol_11.ico, 211
;@Ahk2Exe-AddResource .\icons\vol_12.ico, 212
;@Ahk2Exe-AddResource .\icons\vol_13.ico, 213
;@Ahk2Exe-AddResource .\icons\vol_14.ico, 214
;@Ahk2Exe-AddResource .\icons\vol_15.ico, 215
;@Ahk2Exe-AddResource .\icons\vol_16.ico, 216
;@Ahk2Exe-AddResource .\icons\vol_17.ico, 217
;@Ahk2Exe-AddResource .\icons\vol_18.ico, 218
;@Ahk2Exe-AddResource .\icons\vol_19.ico, 219
;@Ahk2Exe-AddResource .\icons\vol_20.ico, 220
;@Ahk2Exe-AddResource .\icons\vol_21.ico, 221
;@Ahk2Exe-AddResource .\icons\vol_22.ico, 222
;@Ahk2Exe-AddResource .\icons\vol_23.ico, 223
;@Ahk2Exe-AddResource .\icons\vol_24.ico, 224
;@Ahk2Exe-AddResource .\icons\vol_25.ico, 225
;@Ahk2Exe-AddResource .\icons\vol_26.ico, 226
;@Ahk2Exe-AddResource .\icons\vol_27.ico, 227
;@Ahk2Exe-AddResource .\icons\vol_28.ico, 228
;@Ahk2Exe-AddResource .\icons\vol_29.ico, 229
;@Ahk2Exe-AddResource .\icons\vol_30.ico, 230
;@Ahk2Exe-AddResource .\icons\vol_31.ico, 231
;@Ahk2Exe-AddResource .\icons\vol_32.ico, 232
;@Ahk2Exe-AddResource .\icons\vol_33.ico, 233
;@Ahk2Exe-AddResource .\icons\vol_34.ico, 234
;@Ahk2Exe-AddResource .\icons\vol_35.ico, 235
;@Ahk2Exe-AddResource .\icons\vol_36.ico, 236
;@Ahk2Exe-AddResource .\icons\vol_37.ico, 237
;@Ahk2Exe-AddResource .\icons\vol_38.ico, 238
;@Ahk2Exe-AddResource .\icons\vol_39.ico, 239
;@Ahk2Exe-AddResource .\icons\vol_40.ico, 240
;@Ahk2Exe-AddResource .\icons\vol_41.ico, 241
;@Ahk2Exe-AddResource .\icons\vol_42.ico, 242
;@Ahk2Exe-AddResource .\icons\vol_43.ico, 243
;@Ahk2Exe-AddResource .\icons\vol_44.ico, 244
;@Ahk2Exe-AddResource .\icons\vol_45.ico, 245
;@Ahk2Exe-AddResource .\icons\vol_46.ico, 246
;@Ahk2Exe-AddResource .\icons\vol_47.ico, 247
;@Ahk2Exe-AddResource .\icons\vol_48.ico, 248
;@Ahk2Exe-AddResource .\icons\vol_49.ico, 249
;@Ahk2Exe-AddResource .\icons\vol_50.ico, 250
;@Ahk2Exe-AddResource .\icons\vol_51.ico, 251
;@Ahk2Exe-AddResource .\icons\vol_52.ico, 252
;@Ahk2Exe-AddResource .\icons\vol_53.ico, 253
;@Ahk2Exe-AddResource .\icons\vol_54.ico, 254
;@Ahk2Exe-AddResource .\icons\vol_55.ico, 255
;@Ahk2Exe-AddResource .\icons\vol_56.ico, 256
;@Ahk2Exe-AddResource .\icons\vol_57.ico, 257
;@Ahk2Exe-AddResource .\icons\vol_58.ico, 258
;@Ahk2Exe-AddResource .\icons\vol_59.ico, 259
;@Ahk2Exe-AddResource .\icons\vol_60.ico, 260
;@Ahk2Exe-AddResource .\icons\vol_61.ico, 261
;@Ahk2Exe-AddResource .\icons\vol_62.ico, 262
;@Ahk2Exe-AddResource .\icons\vol_63.ico, 263
;@Ahk2Exe-AddResource .\icons\vol_64.ico, 264
;@Ahk2Exe-AddResource .\icons\vol_65.ico, 265
;@Ahk2Exe-AddResource .\icons\vol_66.ico, 266
;@Ahk2Exe-AddResource .\icons\vol_67.ico, 267
;@Ahk2Exe-AddResource .\icons\vol_68.ico, 268
;@Ahk2Exe-AddResource .\icons\vol_69.ico, 269
;@Ahk2Exe-AddResource .\icons\vol_70.ico, 270
;@Ahk2Exe-AddResource .\icons\vol_71.ico, 271
;@Ahk2Exe-AddResource .\icons\vol_72.ico, 272
;@Ahk2Exe-AddResource .\icons\vol_73.ico, 273
;@Ahk2Exe-AddResource .\icons\vol_74.ico, 274
;@Ahk2Exe-AddResource .\icons\vol_75.ico, 275
;@Ahk2Exe-AddResource .\icons\vol_76.ico, 276
;@Ahk2Exe-AddResource .\icons\vol_77.ico, 277
;@Ahk2Exe-AddResource .\icons\vol_78.ico, 278
;@Ahk2Exe-AddResource .\icons\vol_79.ico, 279
;@Ahk2Exe-AddResource .\icons\vol_80.ico, 280
;@Ahk2Exe-AddResource .\icons\vol_81.ico, 281
;@Ahk2Exe-AddResource .\icons\vol_82.ico, 282
;@Ahk2Exe-AddResource .\icons\vol_83.ico, 283
;@Ahk2Exe-AddResource .\icons\vol_84.ico, 284
;@Ahk2Exe-AddResource .\icons\vol_85.ico, 285
;@Ahk2Exe-AddResource .\icons\vol_86.ico, 286
;@Ahk2Exe-AddResource .\icons\vol_87.ico, 287
;@Ahk2Exe-AddResource .\icons\vol_88.ico, 288
;@Ahk2Exe-AddResource .\icons\vol_89.ico, 289
;@Ahk2Exe-AddResource .\icons\vol_90.ico, 290
;@Ahk2Exe-AddResource .\icons\vol_91.ico, 291
;@Ahk2Exe-AddResource .\icons\vol_92.ico, 292
;@Ahk2Exe-AddResource .\icons\vol_93.ico, 293
;@Ahk2Exe-AddResource .\icons\vol_94.ico, 294
;@Ahk2Exe-AddResource .\icons\vol_95.ico, 295
;@Ahk2Exe-AddResource .\icons\vol_96.ico, 296
;@Ahk2Exe-AddResource .\icons\vol_97.ico, 297
;@Ahk2Exe-AddResource .\icons\vol_98.ico, 298
;@Ahk2Exe-AddResource .\icons\vol_99.ico, 299
;@Ahk2Exe-AddResource .\icons\vol_100.ico, 300

; Muted Icons (ID 400 to 500)
;@Ahk2Exe-AddResource .\icons\vol_0_muted.ico, 400
;@Ahk2Exe-AddResource .\icons\vol_1_muted.ico, 401
;@Ahk2Exe-AddResource .\icons\vol_2_muted.ico, 402
;@Ahk2Exe-AddResource .\icons\vol_3_muted.ico, 403
;@Ahk2Exe-AddResource .\icons\vol_4_muted.ico, 404
;@Ahk2Exe-AddResource .\icons\vol_5_muted.ico, 405
;@Ahk2Exe-AddResource .\icons\vol_6_muted.ico, 406
;@Ahk2Exe-AddResource .\icons\vol_7_muted.ico, 407
;@Ahk2Exe-AddResource .\icons\vol_8_muted.ico, 408
;@Ahk2Exe-AddResource .\icons\vol_9_muted.ico, 409
;@Ahk2Exe-AddResource .\icons\vol_10_muted.ico, 410
;@Ahk2Exe-AddResource .\icons\vol_11_muted.ico, 411
;@Ahk2Exe-AddResource .\icons\vol_12_muted.ico, 412
;@Ahk2Exe-AddResource .\icons\vol_13_muted.ico, 413
;@Ahk2Exe-AddResource .\icons\vol_14_muted.ico, 414
;@Ahk2Exe-AddResource .\icons\vol_15_muted.ico, 415
;@Ahk2Exe-AddResource .\icons\vol_16_muted.ico, 416
;@Ahk2Exe-AddResource .\icons\vol_17_muted.ico, 417
;@Ahk2Exe-AddResource .\icons\vol_18_muted.ico, 418
;@Ahk2Exe-AddResource .\icons\vol_19_muted.ico, 419
;@Ahk2Exe-AddResource .\icons\vol_20_muted.ico, 420
;@Ahk2Exe-AddResource .\icons\vol_21_muted.ico, 421
;@Ahk2Exe-AddResource .\icons\vol_22_muted.ico, 422
;@Ahk2Exe-AddResource .\icons\vol_23_muted.ico, 423
;@Ahk2Exe-AddResource .\icons\vol_24_muted.ico, 424
;@Ahk2Exe-AddResource .\icons\vol_25_muted.ico, 425
;@Ahk2Exe-AddResource .\icons\vol_26_muted.ico, 426
;@Ahk2Exe-AddResource .\icons\vol_27_muted.ico, 427
;@Ahk2Exe-AddResource .\icons\vol_28_muted.ico, 428
;@Ahk2Exe-AddResource .\icons\vol_29_muted.ico, 429
;@Ahk2Exe-AddResource .\icons\vol_30_muted.ico, 430
;@Ahk2Exe-AddResource .\icons\vol_31_muted.ico, 431
;@Ahk2Exe-AddResource .\icons\vol_32_muted.ico, 432
;@Ahk2Exe-AddResource .\icons\vol_33_muted.ico, 433
;@Ahk2Exe-AddResource .\icons\vol_34_muted.ico, 434
;@Ahk2Exe-AddResource .\icons\vol_35_muted.ico, 435
;@Ahk2Exe-AddResource .\icons\vol_36_muted.ico, 436
;@Ahk2Exe-AddResource .\icons\vol_37_muted.ico, 437
;@Ahk2Exe-AddResource .\icons\vol_38_muted.ico, 438
;@Ahk2Exe-AddResource .\icons\vol_39_muted.ico, 439
;@Ahk2Exe-AddResource .\icons\vol_40_muted.ico, 440
;@Ahk2Exe-AddResource .\icons\vol_41_muted.ico, 441
;@Ahk2Exe-AddResource .\icons\vol_42_muted.ico, 442
;@Ahk2Exe-AddResource .\icons\vol_43_muted.ico, 443
;@Ahk2Exe-AddResource .\icons\vol_44_muted.ico, 444
;@Ahk2Exe-AddResource .\icons\vol_45_muted.ico, 445
;@Ahk2Exe-AddResource .\icons\vol_46_muted.ico, 446
;@Ahk2Exe-AddResource .\icons\vol_47_muted.ico, 447
;@Ahk2Exe-AddResource .\icons\vol_48_muted.ico, 448
;@Ahk2Exe-AddResource .\icons\vol_49_muted.ico, 449
;@Ahk2Exe-AddResource .\icons\vol_50_muted.ico, 450
;@Ahk2Exe-AddResource .\icons\vol_51_muted.ico, 451
;@Ahk2Exe-AddResource .\icons\vol_52_muted.ico, 452
;@Ahk2Exe-AddResource .\icons\vol_53_muted.ico, 453
;@Ahk2Exe-AddResource .\icons\vol_54_muted.ico, 454
;@Ahk2Exe-AddResource .\icons\vol_55_muted.ico, 455
;@Ahk2Exe-AddResource .\icons\vol_56_muted.ico, 456
;@Ahk2Exe-AddResource .\icons\vol_57_muted.ico, 457
;@Ahk2Exe-AddResource .\icons\vol_58_muted.ico, 458
;@Ahk2Exe-AddResource .\icons\vol_59_muted.ico, 459
;@Ahk2Exe-AddResource .\icons\vol_60_muted.ico, 460
;@Ahk2Exe-AddResource .\icons\vol_61_muted.ico, 461
;@Ahk2Exe-AddResource .\icons\vol_62_muted.ico, 462
;@Ahk2Exe-AddResource .\icons\vol_63_muted.ico, 463
;@Ahk2Exe-AddResource .\icons\vol_64_muted.ico, 464
;@Ahk2Exe-AddResource .\icons\vol_65_muted.ico, 465
;@Ahk2Exe-AddResource .\icons\vol_66_muted.ico, 466
;@Ahk2Exe-AddResource .\icons\vol_67_muted.ico, 467
;@Ahk2Exe-AddResource .\icons\vol_68_muted.ico, 468
;@Ahk2Exe-AddResource .\icons\vol_69_muted.ico, 469
;@Ahk2Exe-AddResource .\icons\vol_70_muted.ico, 470
;@Ahk2Exe-AddResource .\icons\vol_71_muted.ico, 471
;@Ahk2Exe-AddResource .\icons\vol_72_muted.ico, 472
;@Ahk2Exe-AddResource .\icons\vol_73_muted.ico, 473
;@Ahk2Exe-AddResource .\icons\vol_74_muted.ico, 474
;@Ahk2Exe-AddResource .\icons\vol_75_muted.ico, 475
;@Ahk2Exe-AddResource .\icons\vol_76_muted.ico, 476
;@Ahk2Exe-AddResource .\icons\vol_77_muted.ico, 477
;@Ahk2Exe-AddResource .\icons\vol_78_muted.ico, 478
;@Ahk2Exe-AddResource .\icons\vol_79_muted.ico, 479
;@Ahk2Exe-AddResource .\icons\vol_80_muted.ico, 480
;@Ahk2Exe-AddResource .\icons\vol_81_muted.ico, 481
;@Ahk2Exe-AddResource .\icons\vol_82_muted.ico, 482
;@Ahk2Exe-AddResource .\icons\vol_83_muted.ico, 483
;@Ahk2Exe-AddResource .\icons\vol_84_muted.ico, 484
;@Ahk2Exe-AddResource .\icons\vol_85_muted.ico, 485
;@Ahk2Exe-AddResource .\icons\vol_86_muted.ico, 486
;@Ahk2Exe-AddResource .\icons\vol_87_muted.ico, 487
;@Ahk2Exe-AddResource .\icons\vol_88_muted.ico, 488
;@Ahk2Exe-AddResource .\icons\vol_89_muted.ico, 489
;@Ahk2Exe-AddResource .\icons\vol_90_muted.ico, 490
;@Ahk2Exe-AddResource .\icons\vol_91_muted.ico, 491
;@Ahk2Exe-AddResource .\icons\vol_92_muted.ico, 492
;@Ahk2Exe-AddResource .\icons\vol_93_muted.ico, 493
;@Ahk2Exe-AddResource .\icons\vol_94_muted.ico, 494
;@Ahk2Exe-AddResource .\icons\vol_95_muted.ico, 495
;@Ahk2Exe-AddResource .\icons\vol_96_muted.ico, 496
;@Ahk2Exe-AddResource .\icons\vol_97_muted.ico, 497
;@Ahk2Exe-AddResource .\icons\vol_98_muted.ico, 498
;@Ahk2Exe-AddResource .\icons\vol_99_muted.ico, 499
;@Ahk2Exe-AddResource .\icons\vol_100_muted.ico, 500

; Volume Control Pro - Advanced Volume Management for AutoHotkey v2
; Combines custom volume hotkeys with visual tray icon percentage indicator
; Features:
; - Custom volume increments with modifier keys (Ctrl/Shift/Alt)
; - Visual volume percentage shown in system tray icon
; - Single-click tray icon to toggle mute
; - Double-click tray icon to open volume mixer
; - Custom OSD display for volume changes

#Requires AutoHotkey v2.0
#SingleInstance Force

; Initialize
Persistent
UpdateVolumeIcon()

; Prevent hotkey warning dialog
A_MaxHotkeysPerInterval := 200

; Register for audio device change notifications
RegisterAudioDeviceNotifications()

; Create custom tray menu
A_TrayMenu.Delete()
A_TrayMenu.Add("Open Volume Mixer", OpenVolumeMixer)
A_TrayMenu.Add()
A_TrayMenu.Add("Reload Script", (*) => Reload())
A_TrayMenu.Add("Exit", ExitApp)

; Handle tray icon clicks
OnMessage(0x404, TrayClick)

; Listen for device change messages
OnMessage(0x219, WM_DEVICECHANGE)

; ===== VOLUME HOTKEYS =====

; Volume Up with no modifier - increment by 5
Volume_Up::
{
    SoundSetVolume("+5")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Volume Down with no modifier - decrement by 5
Volume_Down::
{
    SoundSetVolume("-5")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Shift + Volume Up - increment by 2
+Volume_Up::
{
    SoundSetVolume("+2")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Shift + Volume Down - decrement by 2
+Volume_Down::
{
    SoundSetVolume("-2")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Alt + Volume Up - increment by 1
!Volume_Up::
{
    SoundSetVolume("+1")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Alt + Volume Down - decrement by 1
!Volume_Down::
{
    SoundSetVolume("-1")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Ctrl + Volume Up - increment by 10
^Volume_Up::
{
    SoundSetVolume("+10")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Ctrl + Volume Down - decrement by 10
^Volume_Down::
{
    SoundSetVolume("-10")
    ShowVolumeOSD()
    StartTemporaryMonitoring()
}

; Volume Mute - toggle mute and show status
Volume_Mute::
{
    SoundSetMute(-1)
    if (SoundGetMute())
        ShowCustomOSD("Volume: Muted")
    else
    {
        currentVolume := Round(SoundGetVolume())
        ShowCustomOSD("Volume: " currentVolume "%")
    }
    StartTemporaryMonitoring()
}

; ===== OSD DISPLAY FUNCTIONS =====

; Function to show Windows volume OSD
ShowVolumeOSD()
{
    currentVolume := Round(SoundGetVolume())
    ShowCustomOSD("Volume: " currentVolume "%")
}

; Function to show custom OSD at bottom center above taskbar
ShowCustomOSD(text)
{
    static osdGui := ""
    
    if (osdGui != "")
    {
        try osdGui.Destroy()
    }
    
    osdGui := Gui("+AlwaysOnTop -Caption +ToolWindow +LastFound")
    osdGui.BackColor := "2c2c2c"
    osdGui.SetFont("s10 cWhite", "Segoe UI")
    
    osdGui.MarginX := 10
    osdGui.MarginY := 10
    osdGui.Add("Text", "Center", text)
    
    osdGui.Show("NoActivate AutoSize")
    
    osdGui.GetPos(, , &guiWidth, &guiHeight)
    
    MonitorGetWorkArea(, , , , &workBottom)
    screenWidth := A_ScreenWidth
    
    xPos := (screenWidth - guiWidth) // 2
    yPos := workBottom - guiHeight - 80
    
    osdGui.Show("NoActivate x" xPos " y" yPos)
    
    SetTimer(() => HideOSD(osdGui), -1000)
}

; Function to hide the OSD
HideOSD(gui)
{
    try gui.Destroy()
}

; ===== TRAY ICON MANAGEMENT =====

; Register for audio device notifications
RegisterAudioDeviceNotifications() {
    ; This sets up Windows to notify us of audio device changes
}

; Handle device change notifications
WM_DEVICECHANGE(wParam, lParam, msg, hwnd) {
    if (wParam = 0x0007 || wParam = 0x8000 || wParam = 0x8004) {
        SetTimer(() => UpdateVolumeIcon(), -100)
    }
}

; Start monitoring volume changes for a short period
StartTemporaryMonitoring() {
    static monitorCount := 0
    
    monitorCount := 0
    SetTimer(MonitorVolumeTemporarily, 100)
}

; Monitor volume changes temporarily
MonitorVolumeTemporarily() {
    static monitorCount := 0
    
    monitorCount++
    UpdateVolumeIcon()
    
    if (monitorCount >= 20) {
        SetTimer(MonitorVolumeTemporarily, 0)
        monitorCount := 0
    }
}

; Update the tray icon with current volume percentage
UpdateVolumeIcon(*) {
    static lastVolume := -1
    static lastMuted := -1
    
    try {
        volume := Round(SoundGetVolume())
        isMuted := SoundGetMute()
        
        if (volume = lastVolume && isMuted = lastMuted)
            return
            
        lastVolume := volume
        lastMuted := isMuted
        
        targetID := isMuted ? (400 + volume) : (200 + volume)
        
        TraySetIcon(A_ScriptFullPath, -targetID)

        deviceName := GetCurrentAudioDevice()
        A_IconTip := deviceName . (isMuted ? " (Muted) " : " ") . volume . "%"
        
    } catch as err {
        A_IconTip := "Load Error: " . err.Message
    }
}

; Get the name of the current default audio playback device
GetCurrentAudioDevice() {
    try {
        CLSID_MMDeviceEnumerator := "{BCDE0395-E52F-467C-8E3D-C4579291692E}"
        IID_IMMDeviceEnumerator := "{A95664D2-9614-4F35-A746-DE8DB63617E6}"
        eRender := 0
        eConsole := 0
        
        DeviceEnumerator := ComObject(CLSID_MMDeviceEnumerator, IID_IMMDeviceEnumerator)
        pDevice := ComObjQuery(DeviceEnumerator, IID_IMMDeviceEnumerator)
        
        ComCall(4, pDevice, "Int", eRender, "Int", eConsole, "Ptr*", &pEndpoint := 0)
        
        STGM_READ := 0x00000000
        ComCall(4, pEndpoint, "UInt", STGM_READ, "Ptr*", &pProps := 0)
        
        PKEY_Device_FriendlyName := Buffer(20, 0)
        DllCall("ole32\CLSIDFromString", "WStr", "{a45c254e-df1c-4efd-8020-67d146a850e0}", "Ptr", PKEY_Device_FriendlyName)
        NumPut("UInt", 14, PKEY_Device_FriendlyName, 16)
        
        PROPVARIANT := Buffer(24, 0)
        ComCall(5, pProps, "Ptr", PKEY_Device_FriendlyName, "Ptr", PROPVARIANT)
        
        deviceName := StrGet(NumGet(PROPVARIANT, 8, "Ptr"), "UTF-16")
        
        DllCall("ole32\PropVariantClear", "Ptr", PROPVARIANT)
        
        ObjRelease(pProps)
        ObjRelease(pEndpoint)
        
        return deviceName ? deviceName : "Audio Device"
    } catch {
        return "Audio Device"
    }
}

; ===== TRAY INTERACTION =====

; Handle tray icon clicks
TrayClick(wParam, lParam, msg, hwnd) {
    if (lParam = 0x202) {
        ToggleMute()
    } else if (lParam = 0x203) {
        OpenVolumeMixer()
    }
}

; Toggle mute status
ToggleMute(*) {
    try {
        if SoundGetMute()
            SoundSetMute(false)
        else
            SoundSetMute(true)
        Sleep(50)
        UpdateVolumeIcon()
    } catch as err {
        MsgBox("Error toggling mute: " err.Message, "Volume Control Pro Error", 16)
    }
}

; Open Windows volume mixer
OpenVolumeMixer(*) {
    try {
        Run("sndvol.exe")
    } catch as err {
        MsgBox("Error opening volume mixer: " err.Message, "Volume Control Pro Error", 16)
    }
}

; Exit the application
ExitApp(*) {
    ExitApp
}